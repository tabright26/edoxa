version: '3.7'

services:
  mssql.test:
    image: mcr.microsoft.com/mssql/server:2017-CU14-ubuntu
    environment:
      - SA_PASSWORD=fnU3Www9TnBDp3MA
      - ACCEPT_EULA=Y
      - MSSQL_PID=Express
    ports:
      - "5433:1433"

  rabbitmq.test:
    image: rabbitmq:3-management-alpine
    ports:
      - "19672:15672"
      - "9672:5672"

  redis.test:
    image: redis:5.0.5
    ports:
      - "10379:6379"

  seedwork.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/seedwork.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: test/eDoxa.Seedwork.UnitTests/Dockerfile

  identity-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/identity-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Identity.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Identity.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp
      
  identity-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/identity-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Identity.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Identity.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${IDENTITY_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  cashier-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/cashier-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Cashier.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Cashier.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  cashier-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/cashier-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Cashier.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Cashier.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${CASHIER_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  challenges-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/challenges-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Challenges.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Challenges.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  challenges-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/challenges-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Challenges.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Challenges.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${CHALLENGES_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  clans-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/clans-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Clans.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Clans.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  clans-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/clans-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Clans.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Clans.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${CLANS_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  games-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/games-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Games.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Games.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  games-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/games-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Games.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test 
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Games.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${GAMES_SQLSERVER_CONNECTIONSTRING}    
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  notifications-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/notifications-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Notifications.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Notifications.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  notifications-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/notifications-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Notifications.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Notifications.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${NOTIFICATIONS_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  payment-api.unit-tests:
    image: ${ACR_REGISTRY:-edoxa}/payment-api.unit-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Payment.Api/Dockerfile
      target: unit-tests
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Payment.UnitTests.trx"
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp

  payment-api.integration-tests:
    image: ${ACR_REGISTRY:-edoxa}/payment-api.integration-tests:${ACR_TAG:-latest}
    build:
      context: ../
      dockerfile: src/eDoxa.Payment.Api/Dockerfile
      target: integration-tests
    depends_on:
      - mssql.test
      - redis.test
    entrypoint: dotnet test --configuration Release --logger "trx;LogFileName=/var/tmp/eDoxa.Payment.IntegrationTests.trx"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ConnectionStrings__AzureKeyVault=${AKV_CONNECTIONSTRING}
      - ConnectionStrings__SqlServer=${PAYMENT_SQLSERVER_CONNECTIONSTRING}
      - Serilog__Sink__Seq=http://seq
    volumes:
      - ${BUILD_ARTIFACTDIRECTORY:-.}/vsts/test/results:/var/tmp